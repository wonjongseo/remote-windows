<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iOS Screen Preview</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    video {
      width: 100%;
      max-width: 720px;
      border: 2px solid #444;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline muted></video>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    (async () => {
      const pc = new RTCPeerConnection();
      const socket = io("http://localhost:3000");

      // 1) SDP (offer/answer) ìˆ˜ì‹ 
      socket.on("sdp", async data => {
        console.log("â–¶ï¸ got SDP", data.type);
        if (data.type === "offer") {
          // iOSê°€ ë³´ë‚¸ offer ì²˜ë¦¬
          await pc.setRemoteDescription(data);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          console.log("â–¶ï¸ send answer", answer);
          socket.emit("sdp", {
            type: answer.type,
            sdp: answer.sdp
          });
        }
        // else if (data.type === "answer") {
        //   // iOSê°€ ë³´ë‚¸ answer ì²˜ë¦¬
        //   await pc.setRemoteDescription(data);
        // }
      });

      // 2) ICE í›„ë³´ ìˆ˜ì‹ 
      socket.on("ice-candidate", data => {
        console.log("â–¶ï¸ got ICE", data);
        pc.addIceCandidate(new RTCIceCandidate(data))
          .catch(e => console.warn("ICE add error", e));
      });

      // 3) ë¸Œë¼ìš°ì € ICE í›„ë³´ â†’ iOS
      pc.onicecandidate = ({ candidate }) => {

        if (candidate) {
          console.log("â–¶ï¸ send ICE", candidate);
          socket.emit("ice-candidate", {
            candidate: candidate.candidate,
            sdpMid: candidate.sdpMid,
            sdpMLineIndex: candidate.sdpMLineIndex
          });
        }
      };

      // 4) ë¹„ë””ì˜¤ íŠ¸ëž™ ìˆ˜ì‹ 
      pc.ontrack = ev => {
        if (ev.track.kind === "video") {
          const video = document.getElementById("remoteVideo");
          if (!video.srcObject) {
            video.srcObject = ev.streams[0];
            video.play().catch(console.error);
            console.log("â–¶ï¸ Playing remote video");
          }
        }
      };

      socket.on("connect", () => console.log("ðŸ”Œ signaling connected"));
      socket.on("disconnect", () => console.log("ðŸ”Œ signaling disconnected"));
    })();
  </script>
</body>
</html>
